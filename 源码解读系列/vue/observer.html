<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="./logo.ico">
    <title>Vue-变化侦测</title>
</head>

<body>
    <h2 id="test"></h2>
    <button id="but">+1</button>
    <script type="module">
        import { Observer } from './src/core/observer/index.js' // Observer类：将Object数据中的所有属性（包括子属性）都转换成getter/seter的形式来侦测变化
        import Watcher from './src/core/observer/watcher.js' // Watcher类：当数据发生变化时，通知Watcher实例，由Watcher实例去做真实的更新操作
        import { parsePath } from './src/core/util/lang.js' // 把一个形如'data.a.b.c'的字符串路径所表示的值，从真实的data对象中取出来

        class Vue {
            constructor(options = {}) {
                this.el = options.el // 当前实例对象
                this.exp = options.exp // 字符串路径
                this.data = options.data // 整个data对象
                el.innerHTML = parsePath(this.exp)(this.data)
                let observer = new Observer(this.data) // 实例化Observer类，把this.data转化成可观测对象 → 监听this.data
                // 实例化Watcher类，将Watcher实例添加到依赖中
                new Watcher(this, `data.${this.exp}`, function(newVal, oldVal) {
                    console.log(`${this.exp}被修改了：${oldVal}=>${newVal}`);
                    el.innerHTML = newVal
                })
                return this
            }
        }
        let el = document.getElementById("test")
        let vue = new Vue({
            el: el,
            exp: 'child.count', // 要监听的key的路径
            data: {
              brand: 'BMW',
              price: 3000,
              child: {
                count: 100,
              },
            }
        })
        // console.log(vue);
        let but = document.getElementById("but")
        but.addEventListener('click', () => {
            var segments = `data.${vue.exp}`.split('.')
            let obj = vue
            for (let i = 0; i < segments.length -1; i++) {
              obj = obj[segments[i]]
            }
            // console.log(obj); // 最内层要监听的对象
            obj[segments[segments.length-1]] += 1
        })

    </script>
</body>

</html>