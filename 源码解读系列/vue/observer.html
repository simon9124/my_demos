<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="./logo.ico">
    <title>Vue-变化侦测</title>
</head>

<body>
    <div id="test">
      <h2 id="testPlus"></h2>
      <button id="plus">+1</button>
      <h2 id="testPush">123</h2>
      <button id="push">push</button>
      <button id="reverse">reverse</button>
      <button id="sort">sort</button>
    </div>
    <script type="module">
        import { Observer } from './src/core/observer/index.js' // Observer类：将Object数据中的所有属性（包括子属性）都转换成getter/seter的形式来侦测变化
        import Watcher from './src/core/observer/watcher.js' // Watcher类：当数据发生变化时，通知Watcher实例，由Watcher实例去做真实的更新操作
        import { parsePath } from './src/core/util/lang.js' // 把一个形如'data.a.b.c'的字符串路径所表示的值，从真实的data对象中取出来

        class Vue {
            constructor(options = {}) {
                this.el = options.el // 当前实例对象
                this.objExp = options.objExp // 字符串路径 - 对象
                this.arrExp = options.arrExp // 字符串路径 - 数组
                this.data = options.data // 整个data对象
                document.getElementById("testPlus").innerHTML = parsePath(this.objExp)(this.data)
                document.getElementById("testPush").innerHTML = parsePath(this.arrExp)(this.data)
                let observer = new Observer(this.data) // 实例化Observer类，把this.data转化成可观测对象 → 监听this.data
                /* 实例化Watcher类，将Watcher实例添加到依赖中 */
                new Watcher(this, `data.${this.objExp}`, function(newVal, oldVal) {
                    console.log(`${this.objExp}被修改了：${oldVal}=>${newVal}`);
                    document.getElementById("testPlus").innerHTML = newVal
                })
                new Watcher(this, `data.${this.arrExp}`, function(newVal, oldVal) {
                    console.log(`${this.arrExp}被修改了：${oldVal}=>${newVal}`);
                    document.getElementById("testPush").innerHTML = newVal
                })
                return this
            }
        }
        let el = document.getElementById("test")
        let vue = new Vue({
            el: el,
            objExp: 'child.count', // 要监听的key的路径 - 对象
            arrExp: 'arr', // 要监听的key的路径 - 数组
            data: {
              brand: 'BMW',
              price: 3000,
              child: {
                count: 100,
              },
              arr: [1, 2, 3]
            }
        })
        // console.log(vue);

        function setListnerObj(exp,type) {
            var segments = `data.${exp}`.split('.')
            let obj = vue
            for (let i = 0; i < segments.length -1; i++) {
              obj = obj[segments[i]]
            }
            // console.log(obj); // 最内层要监听的对象
            let val = obj[segments[segments.length-1]] 
            switch (type) {
              case 'plus':
                obj[segments[segments.length-1]] += 1
                break;
              case 'push':
                val.push(val.length + 1)
                break;
              case 'reverse':
                val.reverse()
                break;
              case 'sort':
                val.sort()
                break;
              default:
                break;
            }
        }

        document.getElementById("plus").addEventListener('click', () => {
            setListnerObj(vue.objExp, 'plus')
        })
        document.getElementById("push").addEventListener('click', () => {
            setListnerObj(vue.arrExp, 'push')
        })
        document.getElementById("reverse").addEventListener('click', () => {
            setListnerObj(vue.arrExp, 'reverse')
        })
        document.getElementById("sort").addEventListener('click', () => {
            setListnerObj(vue.arrExp, 'sort')
        })

    </script>
</body>

</html>